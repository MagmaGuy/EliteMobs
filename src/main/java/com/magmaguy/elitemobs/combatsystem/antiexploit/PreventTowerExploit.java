package com.magmaguy.elitemobs.combatsystem.antiexploit;

import com.magmaguy.elitemobs.api.EliteMobDamagedByPlayerAntiExploitEvent;
import com.magmaguy.elitemobs.config.AntiExploitConfig;
import com.magmaguy.elitemobs.utils.NonSolidBlockTypes;
import org.bukkit.Location;
import org.bukkit.block.Block;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.potion.PotionEffectType;
import org.bukkit.util.Vector;

public class PreventTowerExploit implements Listener {

    @EventHandler
    public void onHit(EliteMobDamagedByPlayerAntiExploitEvent event) {

        if (event.isCancelled()) return;
        if (!event.getEliteMobEntity().getLivingEntity().hasAI()) return;
        if (!AntiExploitConfig.towerAntiexploit) return;

        Location mobLocation = event.getEntity().getLocation().add(new Vector(0.5, 0, 0.5));
        Location playerLocation = event.getEliteMobDamagedByPlayerEvent().getPlayer().getLocation().getBlock().getLocation().add(new Vector(0.5, 0, 0.5));

        if (event.getEliteMobDamagedByPlayerEvent().getPlayer().hasPotionEffect(PotionEffectType.LEVITATION)) return;
        if (playerLocation.getY() - mobLocation.getY() < 2) return;

        Block block1 = playerLocation.clone().add(new Vector(0, -1, 1)).getBlock();
        Block block2 = playerLocation.clone().add(new Vector(0, -1, -1)).getBlock();
        Block block3 = playerLocation.clone().add(new Vector(0, -2, 1)).getBlock();
        Block block4 = playerLocation.clone().add(new Vector(0, -2, -1)).getBlock();
        Block block5 = playerLocation.clone().add(new Vector(1, -1, 0)).getBlock();
        Block block6 = playerLocation.clone().add(new Vector(-1, -1, 0)).getBlock();
        Block block7 = playerLocation.clone().add(new Vector(1, -2, 0)).getBlock();
        Block block8 = playerLocation.clone().add(new Vector(-1, -2, 0)).getBlock();

        if (!(NonSolidBlockTypes.isNonSolidBlock(block1.getType()) &&
                NonSolidBlockTypes.isNonSolidBlock(block2.getType()) &&
                NonSolidBlockTypes.isNonSolidBlock(block3.getType()) &&
                NonSolidBlockTypes.isNonSolidBlock(block4.getType()) &&
                NonSolidBlockTypes.isNonSolidBlock(block5.getType()) &&
                NonSolidBlockTypes.isNonSolidBlock(block6.getType()) &&
                NonSolidBlockTypes.isNonSolidBlock(block7.getType()) &&
                NonSolidBlockTypes.isNonSolidBlock(block8.getType())))
            return;

        //prevent triggering when the player is falling
        if (!event.getEliteMobDamagedByPlayerEvent().getPlayer().isFlying() &&
                NonSolidBlockTypes.isNonSolidBlock(playerLocation.clone().add(new Vector(0, -1, 0)).getBlock().getType())) {
            return;
        }

        event.getEliteMobEntity().incrementAntiExploit(5, "tower");
        event.setTriggered(true);

    }

}
